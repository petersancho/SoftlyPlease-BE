<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TopoOpt Physics-Based Form-Finder - SoftlyPlease Research Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
            color: #000;
            background: #fff url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30"><defs><pattern id="grid" width="30" height="30" patternUnits="userSpaceOnUse"><path d="M 30 0 L 0 0 0 30" fill="none" stroke="%23000" stroke-width="0.3" opacity="0.1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grid)"/></svg>');
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: #fff;
            backdrop-filter: blur(10px);
            padding: 1.5rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 2px solid #000;
            border-top: 2px solid #000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #000;
            font-family: 'Times New Roman', serif;
            border: 1px solid #000;
            padding: 0.5rem 1rem;
            background: #fff;
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        nav a {
            color: #000;
            text-decoration: none;
            font-weight: bold;
            font-family: 'Times New Roman', serif;
            border: 1px solid #000;
            padding: 0.5rem 1rem;
            background: #fff;
            transition: all 0.3s ease;
        }

        nav a:hover {
            background: #000;
            color: #fff;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            padding: 2rem 0;
        }

        .visualization-panel {
            background: #fff;
            border: 2px solid #000;
            border-radius: 0;
            padding: 1rem;
            min-height: 600px;
            position: relative;
        }

        .controls-panel {
            background: #fff;
            border: 2px solid #000;
            border-radius: 0;
            padding: 1.5rem;
            height: fit-content;
        }

        .panel-title {
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 0.5rem;
        }

        .control-group {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #000;
            background: #fff;
        }

        .control-group h3 {
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-item {
            margin-bottom: 1rem;
        }

        .control-item label {
            display: block;
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-item input[type="range"] {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .control-item input[type="number"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #000;
            font-family: 'Times New Roman', serif;
            font-size: 0.9rem;
        }

        .control-item input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        .value-display {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            font-size: 0.8rem;
            color: #000;
            text-align: right;
        }

        .action-buttons {
            margin-top: 2rem;
        }

        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            text-decoration: none;
            border-radius: 0;
            border: 2px solid #000;
            background: #fff;
            color: #000;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 1rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            background: #000;
            color: #fff;
        }

        .btn.primary {
            background: #000;
            color: #fff;
        }

        .btn.primary:hover {
            background: #333;
        }

        .info-panel {
            margin-top: 1rem;
            padding: 1.5rem;
            background: #fff;
            border-radius: 0;
            border: 2px solid #000;
        }

        .info-title {
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .info-text {
            font-family: 'Times New Roman', serif;
            font-size: 0.9rem;
            color: #000;
            line-height: 1.5;
        }

        .status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #fff;
            color: #000;
            padding: 0.5rem 1rem;
            border-radius: 0;
            font-family: 'Times New Roman', serif;
            font-size: 0.8rem;
            z-index: 1000;
            border: 2px solid #000;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            z-index: 2000;
            justify-content: center;
            align-items: center;
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            font-size: 1.2rem;
            border: 2px solid #000;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .controls-panel {
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            nav ul {
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">SoftlyPlease Research Platform</div>
                <nav>
                    <ul>
                        <li><a href="/">Home</a></li>
                        <li><a href="/delaunay-configurator">Delaunay</a></li>
                        <li><a href="/topoopt-configurator">TopoOpt</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="main-content">
            <div class="visualization-panel">
                <h2 class="panel-title">TopoOpt Physics Simulation</h2>
                <div id="canvas-container" style="width: 100%; height: 500px; border: 1px solid #000;">
                    <div style="display: flex; justify-content: center; align-items: center; height: 100%; font-family: 'Times New Roman', serif; font-style: italic;">
                        <p>3D visualization will appear here after computation</p>
                    </div>
                </div>
            </div>

            <div class="controls-panel">
                <h2 class="panel-title">Simulation Controls</h2>
                
                <!-- Force & Stiffness Controls -->
                <div class="control-group">
                    <h3>Force Parameters</h3>
                    
                    <div class="control-item">
                        <label for="strength1">Primary Strength</label>
                        <input type="range" id="strength1" min="0" max="20000" value="15000" step="100">
                        <div class="value-display" id="strength1-value">15000</div>
                    </div>
                    
                    <div class="control-item">
                        <label for="weighting">Mass Weighting</label>
                        <input type="range" id="weighting" min="0" max="1000" value="700" step="10">
                        <div class="value-display" id="weighting-value">700</div>
                    </div>
                    
                    <div class="control-item">
                        <label for="strength2">Secondary Strength</label>
                        <input type="range" id="strength2" min="0" max="10000" value="6500" step="100">
                        <div class="value-display" id="strength2-value">6500</div>
                    </div>
                    
                    <div class="control-item">
                        <label for="strength3">Tertiary Strength</label>
                        <input type="range" id="strength3" min="0" max="10000" value="9000" step="100">
                        <div class="value-display" id="strength3-value">9000</div>
                    </div>
                </div>

                <!-- Solver Behavior Controls -->
                <div class="control-group">
                    <h3>Solver Behavior</h3>
                    
                    <div class="control-item">
                        <label for="damping">Damping Factor</label>
                        <input type="range" id="damping" min="0.0001" max="0.01" value="0.0001" step="0.0001">
                        <div class="value-display" id="damping-value">0.0001</div>
                    </div>
                    
                    <div class="control-item">
                        <label for="iterations">Max Iterations</label>
                        <input type="range" id="iterations" min="10" max="200" value="50" step="5">
                        <div class="value-display" id="iterations-value">50</div>
                    </div>
                    
                    <div class="control-item">
                        <label for="threshold">Convergence Threshold</label>
                        <input type="range" id="threshold" min="0.001" max="0.1" value="0.01" step="0.001">
                        <div class="value-display" id="threshold-value">0.01</div>
                    </div>
                    
                    <div class="control-item">
                        <label for="gravity">Gravity Constant</label>
                        <input type="range" id="gravity" min="0" max="20" value="9.81" step="0.1">
                        <div class="value-display" id="gravity-value">9.81</div>
                    </div>
                </div>

                <!-- Display Controls -->
                <div class="control-group">
                    <h3>Visualization</h3>
                    
                    <div class="control-item">
                        <label for="nodeSize">Node Size</label>
                        <input type="range" id="nodeSize" min="0.1" max="2.0" value="0.5" step="0.1">
                        <div class="value-display" id="nodeSize-value">0.5</div>
                    </div>
                    
                    <div class="control-item">
                        <label for="strutSize">Strut Thickness</label>
                        <input type="range" id="strutSize" min="0.1" max="2.0" value="0.3" step="0.1">
                        <div class="value-display" id="strutSize-value">0.3</div>
                    </div>
                    
                    <div class="control-item">
                        <label for="segments">Curve Segments</label>
                        <input type="range" id="segments" min="3" max="50" value="30" step="1">
                        <div class="value-display" id="segments-value">30</div>
                    </div>
                    
                    <div class="control-item">
                        <input type="checkbox" id="showCaps" checked>
                        <label for="showCaps">Show End Caps</label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn primary" id="solveBtn">Solve Physics</button>
                    <button class="btn" id="resetBtn">Reset Simulation</button>
                    <button class="btn" id="downloadBtn" disabled>Download Result</button>
                </div>

                <!-- Research Context -->
                <div class="info-panel">
                    <h3 class="info-title">Research Context</h3>
                    <p class="info-text">
                        This TopoOpt algorithm demonstrates advanced physics-based form-finding using the Kangaroo solver. 
                        The simulation explores how material properties, gravitational forces, and boundary conditions influence 
                        structural geometry through dynamic relaxation. This represents cutting-edge research in computational 
                        structural design and form optimization.
                    </p>
                    <p class="info-text" style="margin-top: 1rem; font-weight: bold;">
                        Developed by Peter J Wingo-Sancho
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="status" id="status">Ready</div>
    <div class="loading" id="loading">Computing Physics Simulation...</div>

    <!-- Import maps polyfill -->
    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.156.1/build/three.module.js",
                "three/examples/jsm/controls/OrbitControls": "https://unpkg.com/three@0.156.1/examples/jsm/controls/OrbitControls.js",
                "three/examples/jsm/loaders/3DMLoader": "https://unpkg.com/three@0.156.1/examples/jsm/loaders/3DMLoader.js",
                "rhino3dm": "https://unpkg.com/rhino3dm@8.0.0-beta/rhino3dm.module.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three'
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls'
        import { Rhino3dmLoader } from 'three/examples/jsm/loaders/3DMLoader'
        import rhino3dm from 'rhino3dm'

        // Initialize rhino3dm
        let rhino
        let doc
        let scene, camera, renderer, controls

        // Set up loader for converting results to threejs
        const loader = new Rhino3dmLoader()
        loader.setLibraryPath('https://unpkg.com/rhino3dm@8.0.0-beta/')

        // Initialize data object for compute()
        const data = {
            definition: 'TopoOpt.gh',
            inputs: getInputs()
        }

        // Initialize the application
        async function init() {
            try {
                rhino = await rhino3dm()
                console.log('Loaded rhino3dm.')
                
                setupScene()
                setupEventListeners()
                updateValueDisplays()
                
                document.getElementById('status').textContent = 'Ready'
            } catch (error) {
                console.error('Failed to initialize:', error)
                document.getElementById('status').textContent = 'Initialization Failed'
            }
        }

        // Set up Three.js scene
        function setupScene() {
            // Rhino models are z-up
            THREE.Object3D.DefaultUp = new THREE.Vector3(0, 0, 1)

            scene = new THREE.Scene()
            scene.background = new THREE.Color('whitesmoke')

            camera = new THREE.PerspectiveCamera(45, 1, 1, 1000)
            camera.position.set(1, -1, 1)

            renderer = new THREE.WebGLRenderer({ antialias: true })
            renderer.setPixelRatio(window.devicePixelRatio)
            renderer.setSize(500, 500)

            const container = document.getElementById('canvas-container')
            container.innerHTML = ''
            container.appendChild(renderer.domElement)

            controls = new OrbitControls(camera, renderer.domElement)

            // Add lighting
            const directionalLight = new THREE.DirectionalLight(0xffffff, 2)
            scene.add(directionalLight)

            const ambientLight = new THREE.AmbientLight(0x404040)
            scene.add(ambientLight)

            animate()
        }

        // Set up event listeners
        function setupEventListeners() {
            // Range inputs
            const rangeInputs = document.querySelectorAll('input[type="range"]')
            rangeInputs.forEach(input => {
                input.addEventListener('input', updateValueDisplay)
                input.addEventListener('change', onParameterChange)
            })

            // Number inputs
            const numberInputs = document.querySelectorAll('input[type="number"]')
            numberInputs.forEach(input => {
                input.addEventListener('change', onParameterChange)
            })

            // Checkbox inputs
            const checkboxInputs = document.querySelectorAll('input[type="checkbox"]')
            checkboxInputs.forEach(input => {
                input.addEventListener('change', onParameterChange)
            })

            // Buttons
            document.getElementById('solveBtn').addEventListener('click', solve)
            document.getElementById('resetBtn').addEventListener('click', reset)
            document.getElementById('downloadBtn').addEventListener('click', download)
        }

        // Get all input values
        function getInputs() {
            const inputs = {}
            
            // Range inputs
            document.querySelectorAll('input[type="range"]').forEach(input => {
                inputs[input.id] = parseFloat(input.value)
            })
            
            // Number inputs
            document.querySelectorAll('input[type="number"]').forEach(input => {
                inputs[input.id] = parseFloat(input.value)
            })
            
            // Checkbox inputs
            document.querySelectorAll('input[type="checkbox"]').forEach(input => {
                inputs[input.id] = input.checked
            })
            
            return inputs
        }

        // Update value displays
        function updateValueDisplays() {
            document.querySelectorAll('input[type="range"]').forEach(input => {
                const display = document.getElementById(input.id + '-value')
                if (display) {
                    display.textContent = input.value
                }
            })
        }

        // Update single value display
        function updateValueDisplay(event) {
            const input = event.target
            const display = document.getElementById(input.id + '-value')
            if (display) {
                display.textContent = input.value
            }
        }

        // Handle parameter changes
        function onParameterChange() {
            data.inputs = getInputs()
            document.getElementById('status').textContent = 'Parameters Updated'
        }

        // Solve the physics simulation
        async function solve() {
            try {
                showLoading(true)
                document.getElementById('status').textContent = 'Solving Physics...'
                document.getElementById('solveBtn').disabled = true

                // Construct URL for POST /solve
                const url = '/solve'
                const requestData = {
                    definition: data.definition,
                    inputs: data.inputs
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                })

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`)
                }

                const responseJson = await response.json()
                console.log('Response:', responseJson)

                collectResults(responseJson)
                document.getElementById('status').textContent = 'Simulation Complete'
                document.getElementById('downloadBtn').disabled = false

            } catch (error) {
                console.error('Solve error:', error)
                document.getElementById('status').textContent = 'Solve Failed: ' + error.message
            } finally {
                showLoading(false)
                document.getElementById('solveBtn').disabled = false
            }
        }

        // Reset simulation
        function reset() {
            // Reset all inputs to default values
            document.getElementById('strength1').value = 15000
            document.getElementById('weighting').value = 700
            document.getElementById('strength2').value = 6500
            document.getElementById('strength3').value = 9000
            document.getElementById('damping').value = 0.0001
            document.getElementById('iterations').value = 50
            document.getElementById('threshold').value = 0.01
            document.getElementById('gravity').value = 9.81
            document.getElementById('nodeSize').value = 0.5
            document.getElementById('strutSize').value = 0.3
            document.getElementById('segments').value = 30
            document.getElementById('showCaps').checked = true

            updateValueDisplays()
            data.inputs = getInputs()
            
            // Clear scene
            scene.traverse(child => {
                if (!child.isLight) {
                    scene.remove(child)
                }
            })
            
            document.getElementById('status').textContent = 'Reset Complete'
            document.getElementById('downloadBtn').disabled = true
        }

        // Parse response and display results
        function collectResults(responseJson) {
            const values = responseJson.values

            // Clear previous doc
            if (doc !== undefined) {
                doc.delete()
            }

            doc = new rhino.File3dm()

            // Process each output
            for (let i = 0; i < values.length; i++) {
                for (const path in values[i].InnerTree) {
                    const branch = values[i].InnerTree[path]
                    for (let j = 0; j < branch.length; j++) {
                        const rhinoObject = decodeItem(branch[j])
                        if (rhinoObject !== null) {
                            doc.objects().add(rhinoObject, null)
                        }
                    }
                }
            }

            if (doc.objects().count < 1) {
                console.error('No rhino objects to load!')
                return
            }

            // Load rhino doc into three.js scene
            const buffer = new Uint8Array(doc.toByteArray()).buffer
            loader.parse(buffer, function(object) {
                // Clear previous objects
                scene.traverse(child => {
                    if (!child.isLight) {
                        scene.remove(child)
                    }
                })

                // Add new object
                scene.add(object)

                // Zoom to fit
                zoomCameraToSelection(camera, controls, scene.children)
            }, (error) => console.log(error))
        }

        // Decode data tree item to rhino geometry
        function decodeItem(item) {
            const data = JSON.parse(item.data)
            if (item.type === 'System.String') {
                try {
                    return rhino.DracoCompression.decompressBase64String(data)
                } catch {}
            } else if (typeof data === 'object') {
                return rhino.CommonObject.decode(data)
            }
            return null
        }

        // Download result
        function download() {
            if (!doc) return

            const bytes = doc.toByteArray()
            const blob = new Blob([bytes], { type: "application/octet-stream" })
            const filename = data.definition.replace(/\.gh$/, '') + '.3dm'
            const link = document.createElement('a')
            link.href = window.URL.createObjectURL(blob)
            link.download = filename
            link.click()
        }

        // Show/hide loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none'
        }

        // Animation loop
        function animate() {
            requestAnimationFrame(animate)
            if (controls) controls.update()
            if (renderer && scene && camera) {
                renderer.render(scene, camera)
            }
        }

        // Zoom camera to fit selection
        function zoomCameraToSelection(camera, controls, selection, fitOffset = 1.2) {
            const box = new THREE.Box3()
            
            for (const object of selection) {
                if (object.isLight) continue
                box.expandByObject(object)
            }
            
            const size = box.getSize(new THREE.Vector3())
            const center = box.getCenter(new THREE.Vector3())
            
            const maxSize = Math.max(size.x, size.y, size.z)
            const fitHeightDistance = maxSize / (2 * Math.atan(Math.PI * camera.fov / 360))
            const fitWidthDistance = fitHeightDistance / camera.aspect
            const distance = fitOffset * Math.max(fitHeightDistance, fitWidthDistance)
            
            const direction = controls.target.clone()
                .sub(camera.position)
                .normalize()
                .multiplyScalar(distance)
            
            controls.maxDistance = distance * 10
            controls.target.copy(center)
            
            camera.near = distance / 100
            camera.far = distance * 100
            camera.updateProjectionMatrix()
            camera.position.copy(controls.target).sub(direction)
            
            controls.update()
        }

        // Initialize the application
        init()
    </script>
</body>
</html>
